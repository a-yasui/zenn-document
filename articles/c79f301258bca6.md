---
title: "TUS Laravel/PHP Memo"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['PHP', 'TUS', 'Laravel']
published: true
---

TUS: https://tus.io/

Tus ã¯ http ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä¸€ç¨®ã§ã™ã€‚ãã†ã¨ã‚‰ãˆã¦ã¾ã™ã€‚é•ã£ãŸã‚‰ã”ã‚ã‚“ã€‚

PHP ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ä½œã‚‰ã‚Œã¦ãŠã‚Š https://github.com/ankitpokhrel/tus-php ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
Laravel å¯¾å¿œã•ã›ãŸã®ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€å€‹äººçš„ã«ã¯ä¸æº€ã ã£ãŸã®ã§ã€ç´ ã®ã“ã‚Œã‚’ Laravel ã§ä½¿ã£ã¦ã¾ã™ã€‚

ã“ã“ã§ã¯ JS å´ã¯çœãã¾ã™ã€‚

ãã‚Œã®memoæ›¸ãã§ã™ã€‚

## Routing

```php
<?php

Route::middleware('auth')->group(function(){
    Route::any('/tus/upload/{any?}', [TUSMainFileUploadController::class, 'upload'])
        ->where('any', '.*')
        ->name("tus.upload");
});
```

## TUSMainFileUploadController

```php
<?php
namespace App\Http\Controller;

use ACME\DoSomething\DoSomethingService;

class TUSMainFileUploadController extends Controller {
  public function upload(){
    // Laravel ã® TestCase ã‚’é€šã™ç‚ºã®ã”ã‚ŠæŠ¼ã—ç¶™æ‰¿
    // ã“ã‚Œã‚’ã—ãªã„ã¨ã€TestCase ã‚’é€šã—ãŸæ™‚ SymfonyRequest ãŒãšã£ã¨ GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å‹˜é•ã„ã—ã¦ TUS ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚ãªã„äº‹ã«ãªã‚‹
    $server = (new class ('redis') extends Server{
        public function setRequest(Request $request): self
        {
            $this->request = $request;
            return $this;
        }
    })->setRequest((new class () extends Request{
        public function setRequest(HttpRequest $r): self
        {
            $this->request = $r;
            return $this;
        }
    })->setRequest(request()));

    $user = auth()->user();
    
    $events = $server->event();
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $events->addListener('tus-server.upload.created', function(UploadCreated $created){
        \Log::info("[TUS] File Created Request");
    });
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã‚¤ãƒ™ãƒ³ãƒˆ
    $events->addListener('tus-server.upload.progress', function(UploadProgress $uploadProgress){
        \Log::info("[TUS] File Upload Progress");
    });
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‹ãé›†ã‚ã¦ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $events->addListener('tus-server.upload.merged', function(UploadMerged $merged){
        \Log::info("[TUS] File Merged ?");
    });

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
    $server->event()->addListener('tus-server.upload.complete', function (UploadComplete $event) use ($user){
        \Log::info("[TUS] File Complete. Start Checking.");
        try {
            app(DoSomethingService::class)->handleUploadComplete($event, $user);
        } catch (\Exception $e){
            \Log::error($e);
        }
    });

    $response = $server
        ->setUploadDir(storage_path('app/tus'))
        ->setApiPath('/tus/upload')
        ->serve();

    return $response->send();
  }
}
```

## TestCase

```php
<?php
namespace Tests\App\Http\Controller;

use ACME\DoSomething\DoSomethingService;
use Tests\TestCase;

class TUSMainFileUploadControllerTest extends TestCase {
  public function test_running_tus() {
    $user = \App\Model\User::factory()->create();
  
    // TUS ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æ©Ÿæ§‹ãŒå‹•ãã‹è¦‹ã¦ã‚‹ã ã‘ãªã®ã§ã€å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã—ã¦ãªã„ã€‚
    $this->app->instance(
        DoSomethingService::class,
        mock(DoSomethingService::class, function (\Mockery\MockInterface $m){
            $m->shouldReceive('handleUploadComplete')->never();
        })
    );
    
    $test = $this
      ->actingAs($user)
      ->get(route('tus.upload', []), ['Tus-Resumable' => '1.0.0']);
    
    $test->assertNotFound();
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    $metadata = collect([
      'filename' => 'hogeratta.png',
      'filetype' => 'image/png',
      'param1' => '123',
      'public_date' => '2025/10/10 00:00:00'
    ])->map(fn($v, $k) => "{$k} " . base64_encode($v))
      ->flatten()
      ->implode(",");
    
    $test = $this
      ->actingAs($user)
      ->post( route('tus.upload', []), [],
        [
          'Tus-Resumable' => '1.0.0',
          'Upload-Length' => 6,
          'Upload-Metadata' => $metadata
        ]
      );
    $test->assertStatus(201);
    
    // å®Ÿãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ Location Header ã®UploadURLã«æŠ•ã’ã‚‹
    $test->assertHeader("Location");
    $location = $test->headers->get('Location');
    
    $test = $this
      ->actingAs($user)
      ->patch($location, ['aaaaaa']);

    // OctetStream ã«ãªã£ã¦ãªã„ã®ã§ 415 ãŒè¿”ã‚‹ã®ãŒæ­£å¸¸ã€‚ã“ã“ã®ãƒ†ã‚¹ãƒˆã¯TUSãŒæœŸå¾…é€šã‚Šã‹è¦‹ã‚‹ãŸã‚ã®ç‰©ãªã®ã§ã€ã“ã‚Œã§ok
    $test->assertStatus(415);
  }
}

```
