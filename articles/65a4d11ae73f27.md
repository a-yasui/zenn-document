---
title: "Laravel 9 Upgrade Memo"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['laravel']
published: false
---

Laravel9が2022/02/08リリースされたので、新機能およびアップグレードメモ。

前回の LTS が Laravel 6（2019/09/03 Release）なので、それから久しぶりの LTSです。

サポートしているPHPが 8.0〜8.1（現在の所。おそらく8系はサポート？）となっており、7.x 系は動きません。これにともない [named arguments -- www.php.net](https://www.php.net/manual/en/functions.arguments.php#functions.named-arguments) がサポートされます。


バグフィックスは 2024/02/08まで、セキュリティフィックスは 2025/02/08 までです。


わりとクソデカ変更ですので、アップグレードは注意です。 PHP7→PHP8 で返り値が追加とか、SymfonyMail へ変更とか。

# 変更点

- [NEW][インパクト高] PHP8.0
- [NEW][インパクト高] Symfony Mailer
- [NEW] Flysystem 3.x
- [NEW] Improved Eloquent Accessors / Mutators
- [NEW][PHP8.1+] Enum Eloquent Attribute Casting
- [NEW] Implicit Route Bindings With Enums
- [NEW] Forced Scoping Of Route Bindings
- [NEW] Controller Route Groups
- [NEW] Full Text Indexes / Where Clauses
- [NEW] Laravel Scout Database Engine
- [NEW] Rendering Inline Blade Templates
- [NEW] Slot Name Shortcut
- [NEW] Checked / Selected Blade Directives
- [NEW] Bootstrap 5 Pagination Views
- [NEW] Improved Validation Of Nested Array Data
- [NEW] Laravel Breeze API & Next.js
- [NEW] Improved Ignition Exception Page
- [NEW] Improved `route:list` CLI Output
- [NEW] Test Coverage Using Artisan `test` Command
- [NEW] Soketi Echo Server
- [NEW] Improved Collections IDE Support
- [NEW] New Helpers

# アップグレード方法

composer.json を変更してください。

- 変更: `laravel/framework:^9.0`
- 変更: `nunomaduro/collision:^6.0`
- 追加: `facade/ignition`
- 追加: `spatie/laravel-ignition": "^1.0"`

さらに Notification のアップグレードもありますので、各自頑張ってください。


## [NEW][インパクト高]  PHP8.0

PHP 8.0.2 以上が推奨です。ただ、Enum使うために PHP8.1以上が良いかも。

see : https://laravel.com/docs/9.x/upgrade#updating-dependencies

### Return Type

PHP Methods の `offsetGet`,`offsetSet` の返り値が付きました。ゴリゴリ書いて行きましょう。

# Application

## [変更][インパクト低] The Application Contract

`Illuminate\Contracts\Foundation\Application` クラスの `storagePath` に `$path` 引数が付きました。継承して使っている時は `public function storagePath($path = '');` 的にしましょう。

## [変更][インパクト低]  Exception Handler ignore Method

同じクラスの `ignore` メソッドが `public` になりましたので、追従変更をしてください。


# Blade


## [NEW][インパクト高] Symfony Mailer

SwiftMailerが使われていましたが、2021/12からメンテナンスがされていないので、SymfonyMailerに乗り換えました。

これにともない、たくさんの変更点があります。（白目）

see : [Upgrade : Symfony Mailer -- laravel.com](https://laravel.com/docs/9.x/upgrade#symfony-mailer)

### ドライバーとしての前提条件

mailgun や postmark のドライバーをそれぞれインストールする必要があります。

```shell
> composer require symfony/mailgun-mailer
```


```shell
> composer require symfony/sendgrid
```

### send/html/text/plain の返り値の変更

今まで送信数を返していたのが `Illuminate\Mail\SentMessage`インスタンスに変更されました。このオブジェクトは `Symfony\Component\Mailer\SentMessage` の継承クラスで `getSymfonySentMessage`で動的に作成されたメッセージのアクセスができます。

### Rename `Swift` to `Symfony`

Laravel 8 の頃と 9 になってからでは、メソッド名が変更されています。

```php
// Laravel 8.x...
$this->withSwiftMessage(function ($message) {
    $message->getHeaders()->addTextHeader(
        'Custom-Header', 'Header Value'
    );
});
 
// Laravel 9.x...
use Symfony\Component\Mime\Email;
 
$this->withSymfonyMessage(function (Email $message) {
    $message->getHeaders()->addTextHeader(
        'Custom-Header', 'Header Value'
    );
});
```

`Email` クラスのメソッドは [Symfony Mailer -- symfony.com](https://symfony.com/doc/current/mailer.html#creating-sending-messages) で確認できます。

#### Proxied `Illuminate\Mail\Message` methods

`Illuminate\Mail\Message` は存在しないメソッドにアクセスした場合は `Swift_Message` のメソッドを呼び出していました。したがって、対応するメソッドを `Symfony\Component\Mime\Email` に変更する必要あります。

```php
// Laravel 8.x...
$message
    ->setFrom('taylor@laravel.com')
    ->setTo('example@example.org')
    ->setSubject('Order Shipped')
    ->setBody('<h1>HTML</h1>', 'text/html')
    ->addPart('Plain Text', 'text/plain');
 
// Laravel 9.x...
$message
    ->from('taylor@laravel.com')
    ->to('example@example.org')
    ->subject('Order Shipped')
    ->html('<h1>HTML</h1>')
    ->text('Plain Text');
```

#### Generated Messages IDs

よくわからん

#### Forced Reconnections

よくわからん。

メール送信時の接続に失敗した時に再接続をするが、それも失敗した時は例外を投げて終わる感じ？

#### SMTP Stream Options

SMTP の stream オプションがサポートされなくなりました。代わりに直接に定義をすることになります。これらのメールの設定は [Symfony の Transport Setup](https://symfony.com/doc/current/mailer.html#transport-setup)を参考にしてください。


```php
'smtp' => [
    // Laravel 8.x...
    'stream' => [
        'ssl' => [
            'verify_peer' => false,
        ],
    ],
 
    // Laravel 9.x...
    'verify_peer' => false,
],
```

#### SMTP `auth_mode`

mail 設定の `auth_mode` はサポートされなくなりました。

#### Failed Recipients

メールの送信後に失敗した受信者リストを取得することができなくなりました（え、できたの？）

代わりに送信に失敗すると `Symfony\Component\Mailer\Exception\TransportExceptionInterface` の例外を放つようになりました。メールアドレスの検証は送信前にチェックするようにしましょう。

