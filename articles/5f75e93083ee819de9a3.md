---
title: "SELinux ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã§ãƒãƒã£ãŸãƒ¡ãƒ¢"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['centos','selinux']
published: false
---

ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å¤‰ãˆã¦ã‚‚ã†ã¾ã nginx ãŒå‹•ã‹ãªã‹ã£ãŸãŒã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã® context ãŒé•ã†ãŸã‚ã« permission denided ã§ã‚³ã‚±ã¦ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦å†èµ·å‹•ã™ã‚Œã°ã„ã„ã®ã ã‘ã©ã€ãã‚Œã¯ãã‚Œã§ãªã‚“ã‹é•ã†æ°—ã‚‚ã™ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨èª¿æŸ»ãƒ¡ãƒ¢ã€‚

ãã‚‚ãã‚‚ http ã®æƒ³å®šå¤–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ã„ã¦ã‚‹ã®ãŒåŸå› ã€‚SELinux ã‚’ enforcing ã‹ã‚‰ permissive ã«ã™ã‚‹ã®ãŒã„ã„ã¨æ€ã†ã€‚

ä»¥ä¸‹ã€å‹‰å¼·ãŒã¦ã‚‰ã‚¬ã‚µã‚¬ã‚µã‚¢ã‚µãƒƒãŸãƒ¡ãƒ¢

# context

Ansible ã§ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¦ã„ã‚‹ã¨ãã«ã€virtualbox ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¯å‰Šé™¤ã™ã‚‹ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã¦ã€nginxã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã§ãã‚‹ãŒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•·ã„ãŸå¾Œã§å¿…ãšã‚³ã‚±ã‚‹ã€‚`nginx: [emerg] open() "/srv/hoge/log/access.log" failed (13: Permission denied)` ãŒåŸå› ãªã®ã¯ã‚ã‹ã‚‹ã‚“ã ãŒã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯åˆã‚ã—ã¦ã„ã‚‹ã€‚

ãã‚Œã§ SELinux ã®è¨­å®šã¯ã„ã˜ã£ã¦ã„ãªã„ã®ã§ã€ä¸­ã‚’è¦—ã„ãŸã®ãŒãã£ã‹ã‘ã€‚

## Success Pattern

```
[root@localhost ~]# stat /srv/hoge/log/access.log
  File: '/srv/hoge/log/access.log'
  Size: 0         	Blocks: 0          IO Block: 4096   regular empty file
Device: 801h/2049d	Inode: 67522172    Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Context: system_u:object_r:httpd_cache_t:s0
Access: 2021-04-07 12:17:31.176670796 +0000
Modify: 2021-04-07 12:17:31.176670796 +0000
Change: 2021-04-07 12:17:31.176670796 +0000
 Birth: -
```

## Fail Pattern

```
[root@localhost ~]# stat /srv/hoge/log/access.log
  File: '/srv/hoge/log/access.log'
  Size: 0         	Blocks: 0          IO Block: 4096   regular empty file
Device: 801h/2049d	Inode: 67522171    Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Context: unconfined_u:object_r:var_t:s0
Access: 2021-04-07 12:14:15.549764123 +0000
Modify: 2021-04-07 12:14:15.549764123 +0000
Change: 2021-04-07 12:14:15.549764123 +0000
 Birth: -

```

# Context

see : [5.7. SELINUX ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ -- redhat customer portal](https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/security-enhanced_linux/sect-security-enhanced_linux-working_with_selinux-selinux_contexts_labeling_files)

fail pattern ã§ã¯ `unconfined_u:object_r:var_t:s0` ã¨ã‚ã‚‹ã®ã§ã€User:`unconfined_u` Role:`object_r` Type:`var_t` Level:`s0` ã¨ãªã£ã¦ã„ã‚‹ã€‚ä¸€æ–¹ã§ Success Pattern ã§ã¯ User:`system_u` Role:`object_r` Type:`httpd_cache_t` Level:`s0` ã¨ã€User,Type ãŒé•ã†ãŸã‚ã«æ€’ã‚‰ã‚Œã‚‹ã€‚

å¤‰æ›´ã«ã¯ `chcon`,`segmanage fcontext` ãŒã‚ã‚‹ã€‚

## chcon

ä¸€æ™‚çš„ã« Context ã‚’å¤‰æ›´ã•ã›ã‚‹ã€‚ `restorecon` ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨å¤‰æ›´å‰ã«æˆ»ã‚Šã¾ã™ã€‚å¤‰æ›´ã«ã¯ `chcon system_u:object_r:httpd_cache_t:s0 <file>` ã¿ãŸã„ãªä½¿ã„æ–¹ã€‚

## segmanage

see : [5.7.2. æ°¸ç¶šçš„ãªå¤‰æ›´: SEMANAGE FCONTEXT -- red hat customer Portal](https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/security-enhanced_linux/sect-security-enhanced_linux-selinux_contexts_labeling_files-persistent_changes_semanage_fcontext)

å½“ç’°å¢ƒï¼ˆCentOS7ï¼‰ã«ã¯æ¨™æº–ã§å…¥ã£ã¦ã„ãªã„ã®ã§ `yum -y install policycoreutils-python` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚

User,Type ã‚’è¿½åŠ ï¼Ÿï¼ˆå¤‰æ›´ã§ã‚‚ã„ã„ã‚ˆã†ãªæ°—ã‚‚ã™ã‚‹ãŒï¼‰ã™ã‚‹ã«ã¯ `semanage fcontext -a -u system_u -r httpd_cache_t /srv/hoge/log` ã¨ã‹ã™ã‚Œã°ã„ã„æ„Ÿã˜ã£ã½ã„ã€‚


