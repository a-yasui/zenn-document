---
title: "Temportal Table at mariadb ã®ãƒ¡ãƒ¢æ›¸ã"
emoji: "ğŸª­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['mariadb']
published: false
---

[Temportal Table -- mariadb.com](https://mariadb.com/kb/en/temporal-tables/) ã®ãƒ¡ãƒ¢æ›¸ãã€‚

ã“ã®æ©Ÿèƒ½ã¯ [SQL:2011 -- wikipedia.org](https://en.wikipedia.org/wiki/SQL:2011) ã«æº–ã˜ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚MariaDBã§ã¯ [10.3.4 ã§è¿½åŠ  -- mariadb.com](https://mariadb.com/kb/en/changes-improvements-in-mariadb-10-3/)ã•ã‚ŒãŸæ©Ÿèƒ½ã§ã‚ã‚Šã€ [10.4.3 ã§ Application Time Periods -- mariadb.com](https://mariadb.com/kb/en/mariadb-1043-release-notes/) ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚½ãƒ•ãƒˆã§ã¯ [SQL Server 2016 -- learn.microsoft.com](https://learn.microsoft.com/ja-jp/sql/relational-databases/tables/temporal-tables?view=sql-server-ver16) ã‚„ [Oracle 12c -- www.oracle.com](https://www.oracle.com/webfolder/technetwork/tutorials/obe/db/12c/r1/ilm/temporal/temporal.html) ã§ä½¿ãˆã‚‹ã¿ãŸã„ã§ã™ã€‚

Temportal Table ã¯ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚

ä¸‰ç¨®é¡ã‚ã£ã¦ System Versioning Tables , Application Time Periods , Bitemporal Tables ã®ä¸‰ç¨®é¡ãŒã‚ã‚‹ã€‚

- System Versioning Tables ã¯ã‚¯ã‚¨ãƒªãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´å±¥æ­´ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å˜ä½ã§æŒã¡ã¾ã™ã€‚
- Application Time Periods ã¯ãƒ‡ãƒ¼ã‚¿å†…ã«ã‚ã‚‹æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚’è¦‹ã¦æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- Bitemporal Tables ã¯ System Versioning Tables ã¨ Application Time Periods ã®è¤‡åˆç‰©ã§ã™ã€‚

å€‹äººçš„ã«ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ãŸã¨ãã®ãƒ‡ãƒ¼ã‚¿å®¹é‡ã¨ã‹å†…å®¹ãŒã©ã†ãªã‚‹ã‚“ã‚„ã¨ã„ã†ç–‘å•ãŒã‚ã‚‹ã®ã§ãƒ¡ãƒ¢æ›¸ãã€‚

# System Versioning Tables

ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã—ãŸå±¥æ­´ã‚„ã€ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªä½“ã®æ“ä½œå±¥æ­´ã‚’ä¿æŒã—ã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆæ™‚ã«æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€é€”ä¸­ã‹ã‚‰æœ‰åŠ¹ã«ã™ã‚‹äº‹ã‚‚ã§ãã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã®å‰¯ä½œç”¨ã¨ã—ã¦ TRUNCATE ã¯å‹•ãã¾ã›ã‚“ã€‚^[ãŸã ã—ã“ã‚Œã¯ MariaDB 10.4.5 ä»¥ä¸Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«é™ã‚Šã¾ã™ã€‚ãã‚Œã‚ˆã‚Šå‰ã¯æ¶ˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚]

:::message
SQL 2011 ã§ã¯ START/END ã®ã‚«ãƒ©ãƒ ãŒå¿…è¦ã§ã™ãŒã€Maria DB ã§ã¯ç„¡ãã¦ã‚‚å‹•ãã¾ã™ã€‚ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç§»è¡Œã™ã‚‹äº‹ã‚’è€ƒãˆã‚‹æ™‚ã¯å¿…è¦ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãŸã æ³¨æ„ãŒå¿…è¦ãªã®ãŒ START/END ã®ã‚«ãƒ©ãƒ ã‚’æ›¸ã‹ãšã«ä½œæˆã—ãŸå ´åˆã€ `ROW_START`/`ROW_END` ã®éš ã—ã‚«ãƒ©ãƒ ã¿ãŸã„ãªã®ã‚’æŒã¡ã¾ã™ã€‚åå‰ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã‚’ã—ãŸã»ã†ãŒè‰¯ã„ã§ã™ã€‚

```sql
-- SQL:2011
CREATE TABLE t(
   x INT,
   start_timestamp TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
   end_timestamp TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
   PERIOD FOR SYSTEM_TIME(start_timestamp, end_timestamp)
) WITH SYSTEM VERSIONING;

-- Mariadb
CREATE TABLE t(
   x INT
) WITH SYSTEM VERSIONING;
```
:::

Alteræ–‡ã‚’ä½¿ã£ã¦é€”ä¸­ã‹ã‚‰è¿½åŠ ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚‹ã€‚

```sql
----------------------------------------------------------------------------------
-- MariaDB:: é€”ä¸­ã‹ã‚‰ Alteræ–‡ã§è¿½åŠ /å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
CREATE TABLE t( x INT );
ALTER TABLE t ADD SYSTEM VERSIONING;

> show create table t\G
*************************** 1. row ***************************
       Table: t
Create Table: CREATE TABLE `t` (
  `x` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci WITH SYSTEM VERSIONING
1 row in set (0.003 sec)

----------------------------------------------------------------------------------
-- ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨åŒæ§˜ã« start/end ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

ALTER TABLE t ADD COLUMN ts TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
              ADD COLUMN te TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
              ADD PERIOD FOR SYSTEM_TIME(ts, te),
              ADD SYSTEM VERSIONING;

> show create table t\G
*************************** 1. row ***************************
       Table: t
Create Table: CREATE TABLE `t` (
  `x` int(11) DEFAULT NULL,
  `ts` timestamp(6) GENERATED ALWAYS AS ROW START,
  `te` timestamp(6) GENERATED ALWAYS AS ROW END,
  PERIOD FOR SYSTEM_TIME (`ts`, `te`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci WITH SYSTEM VERSIONING
1 row in set (0.000 sec)

> show fields from t;
+-------+--------------+------+-----+---------+------------------+
| Field | Type         | Null | Key | Default | Extra            |
+-------+--------------+------+-----+---------+------------------+
| x     | int(11)      | YES  |     | NULL    |                  |
| ts    | timestamp(6) | NO   |     | NULL    | STORED GENERATED |
| te    | timestamp(6) | NO   |     | NULL    | STORED GENERATED |
+-------+--------------+------+-----+---------+------------------+
3 rows in set (0.010 sec)

-- ã“ã®çŠ¶æ…‹ã§ versioning ã‚’æ¶ˆãã†ã¨ã—ã¦ã‚‚ã‚³ã‚±ã‚‹ã€‚
-- ã“ã®çŠ¶æ…‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»˜ã„ã¦ã„ã‚‹ versioning ã®æ¶ˆã—æ–¹ã¯ã¡ã‚‡ã£ã¨ã‚ã‹ã‚‰ã‚“ã€‚
> alter table t drop system versioning;
ERROR 4125 (HY000): Wrong parameters for `t`: missing 'DROP COLUMN `ts`'

----------------------------------------------------------------------------------
-- å‰Šé™¤
ALTER TABLE t DROP SYSTEM VERSIONING;

> show create table t\G
*************************** 1. row ***************************
       Table: t
Create Table: CREATE TABLE `t` (
  `x` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
1 row in set (0.003 sec)

```

## ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ã¨æ›´æ–°

è¿½åŠ ãƒ»æ›´æ–°ã‚’ã—ã¦ã¿ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒã©ã†ã„ã†å…¥ã‚Šæ–¹ã‚’ã™ã‚‹ã‹ã‚’è¦‹ã‚‹ã€‚

```sql
--------------------------------------------------------------------------------------
-- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã„ã‚‹é€šã‚Šã«ã¾ãšå®Ÿè¡Œã‚’ã™ã‚‹

> select now();
+---------------------+
| now()               |
+---------------------+
| 2023-10-04 07:47:11 |
+---------------------+
1 row in set (0.001 sec)

MariaDB [sys_temporal]> insert into t values(1);
Query OK, 1 row affected (0.004 sec)

MariaDB [sys_temporal]> set @@timestamp = UNIX_TIMESTAMP('2033-10-01');
Query OK, 0 rows affected (0.000 sec)

MariaDB [sys_temporal]> insert into t values(2);
Query OK, 1 row affected (0.001 sec)

MariaDB [sys_temporal]> set @@timestamp = default;
Query OK, 0 rows affected (0.000 sec)

MariaDB [sys_temporal]> insert into t values(3);
Query OK, 1 row affected (0.002 sec)

MariaDB [sys_temporal]> select x,row_start,row_end from t;
+------+----------------------------+----------------------------+
| x    | row_start                  | row_end                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    2 | 2033-10-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    3 | 2023-10-04 07:47:47.113555 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
3 rows in set (0.001 sec)

--------------------------------------------------------------------------------------
-- æœªæ¥ã«è¡Œãã€ãƒ‡ãƒ¼ã‚¿ã‚’ï¼‘ä»¶æ¶ˆã—ã¦ã¿ã‚‹

MariaDB [sys_temporal]> set @@timestamp = UNIX_TIMESTAMP('2028-01-01');
Query OK, 0 rows affected (0.004 sec)

MariaDB [sys_temporal]> delete from t where x = 3;
Query OK, 1 row affected (0.006 sec)

MariaDB [sys_temporal]> insert into t values (4);
Query OK, 1 row affected (0.001 sec)

MariaDB [sys_temporal]> set @@timestamp = default;
Query OK, 0 rows affected (0.001 sec)

MariaDB [sys_temporal]> select x,row_start,row_end from t;
+------+----------------------------+----------------------------+
| x    | row_start                  | row_end                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    2 | 2033-10-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
3 rows in set (0.002 sec)

--------------------------------------------------------------------------------------
-- æœªæ¥ã§å…¥ã‚ŒãŸå€¤ã¨åŒã˜å€¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦ã¿ã‚‹ã€‚
MariaDB [sys_temporal]> select NOW();
+---------------------+
| NOW()               |
+---------------------+
| 2023-10-04 07:50:50 |
+---------------------+
1 row in set (0.001 sec)

MariaDB [sys_temporal]> insert into t values(4);
Query OK, 1 row affected (0.002 sec)

MariaDB [sys_temporal]> select *, ROW_START, ROW_END from t;
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    2 | 2033-10-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.001 sec)

--------------------------------------------------------------------------------------
-- æœªæ¥ã«è¡Œãã€ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ã¿ã‚‹ã€‚
MariaDB [sys_temporal]> set @@timestamp = UNIX_TIMESTAMP('2027-12-12');
Query OK, 0 rows affected (0.002 sec)

MariaDB [sys_temporal]> UPDATE t set x = 4 where x = 2;
Query OK, 1 row affected (0.007 sec)
Rows matched: 1  Changed: 1  Inserted: 1  Warnings: 0

MariaDB [sys_temporal]> select *, ROW_START, ROW_END from t;
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.002 sec)

MariaDB [sys_temporal]> set @@timestamp = default;
Query OK, 0 rows affected (0.000 sec)

MariaDB [sys_temporal]> select *, ROW_START, ROW_END from t;
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.001 sec)


```

### æ™‚é–“ã‚’æ­ªã¾ã—ãŸãƒ‡ãƒ¼ã‚¿æ“ä½œã®ã¾ã¨ã‚

ã“ã“ã¾ã§ã§ãã¡ã‚ƒãã¡ã‚ƒã«ãƒ‡ãƒ¼ã‚¿ãŒãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚å°‘ã—æ•´ç†ã‚’ã—ã¾ã™ã€‚

- 2023-10-04 :: å€¤ 1, 3, 4 ã‚’è¿½åŠ 
- 2027-12-12 :: å€¤ 2 ã‚’ 4 ã«å¤‰æ›´
- 2028-01-01 :: å€¤ 3 ã‚’å‰Šé™¤ã€4 ã‚’è¿½åŠ 
- 2033-10-01 :: å€¤ 2 ã‚’è¿½åŠ 

ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ãƒ»å‰Šé™¤ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã€‚å¤šåˆ† 2027-12-12 ãŒå¤‰ãªã“ã¨ã«ãªã‚‹ã¯ãšï¼ˆ2027-12-12 æ™‚ç‚¹ã§ã¯ 2ã¯å­˜åœ¨ã—ãªã„ãŸã‚ï¼‰ã ãŒã€ç¾çŠ¶ã©ã†ãªã£ã¦ã„ã‚‹ã‹ã‚’è¦‹ã‚‹ã€‚

```sql
MariaDB [sys_temporal]> select NOW();
+---------------------+
| NOW()               |
+---------------------+
| 2023-10-04 08:02:48 |
+---------------------+
1 row in set (0.004 sec)

MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME BETWEEN (NOW() - INTERVAL 1 YEAR) AND NOW();
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    3 | 2023-10-04 07:47:47.113555 | 2028-01-01 00:00:00.000000 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
3 rows in set (0.004 sec)


MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME BETWEEN '2027-01-01' AND '2027-12-30';
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    3 | 2023-10-04 07:47:47.113555 | 2028-01-01 00:00:00.000000 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.002 sec)


--------------------------------------------------------------------------------------
-- å•é¡Œã¨ãªã£ã¦ã„ã‚‹æ—¥ã‚’è¦‹ã‚‹ã€‚ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã§ã¯ãªãã€ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME as of TIMESTAMP'2027-12-11 00:00:00';
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    3 | 2023-10-04 07:47:47.113555 | 2028-01-01 00:00:00.000000 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
3 rows in set (0.001 sec)

MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME as of TIMESTAMP'2027-12-12 00:00:00';
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    3 | 2023-10-04 07:47:47.113555 | 2028-01-01 00:00:00.000000 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.001 sec)

--------------------------------------------------------------------------------------
-- éå»ã«å¤‰ãˆã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ãŸæ—¥ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹è¦‹ã‚‹ã€‚
MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME as of TIMESTAMP'2033-09-29 00:00:00';
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.001 sec)

MariaDB [sys_temporal]> SELECT *, ROW_START, ROW_END FROM t FOR SYSTEM_TIME as of TIMESTAMP'2033-10-01 00:00:00';
+------+----------------------------+----------------------------+
| x    | ROW_START                  | ROW_END                    |
+------+----------------------------+----------------------------+
|    1 | 2023-10-04 07:47:17.900020 | 2038-01-19 03:14:07.999999 |
|    4 | 2027-12-12 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2028-01-01 00:00:00.000000 | 2038-01-19 03:14:07.999999 |
|    4 | 2023-10-04 07:50:59.064405 | 2038-01-19 03:14:07.999999 |
+------+----------------------------+----------------------------+
4 rows in set (0.001 sec)
-- å¤‰ãˆã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€2ã¯å­˜åœ¨ã—ãªã“ã¨ã«ãªã£ãŸæ°—é…ã€‚
```

æ—¥ä»˜ã‚’æ°—ã«ã›ãšã€ã¨ã‚Šã‚ãˆãšå…¨ä»¶å–å¾—ã™ã‚‹ã€‚

```sql
MariaDB [sys_temporal]> select NOW();
+---------------------+
| NOW()               |
+---------------------+
| 2023-10-04 08:09:52 |
+---------------------+
1 row in set (0.002 sec)

MariaDB [sys_temporal]> SELECT * FROM t FOR SYSTEM_TIME ALL;
+------+
| x    |
+------+
|    1 |
|    4 |
|    3 |
|    4 |
|    4 |
+------+
5 rows in set (0.002 sec)
```

### View ã‚„ ã‚µãƒ–ã‚¯ã‚¨ãƒªãƒ¼ç­‰

View ã®ä½œæˆæ™‚ã‚„ã‚µãƒ–ã‚¯ã‚¨ãƒªãƒ¼ç™ºè¡Œæ™‚ã«æ—¥ä»˜æŒ‡å®šã¯ã§ãã€ `<table> FOR SYSTEM_TIME AS OF TIMESTAMP'2016-10-09 08:07:06';` ã¨ã„ã£ãŸæ„Ÿã˜ã«ãªã‚‹ã€‚

```sql
CREATE VIEW v1 AS SELECT * FROM t FOR SYSTEM_TIME AS OF TIMESTAMP'2016-10-09 08:07:06';

-- or

CREATE VIEW v1 AS SELECT * FROM t;
SELECT * FROM v1 FOR SYSTEM_TIME AS OF TIMESTAMP'2016-10-09 08:07:06';
```

### ãã®ä»–

ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãªã©ã¯ä¸€ãƒ¶æœˆå˜ä½ã§åˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚ŒãŸã‚Šã§ãã‚‹ã€‚

```sql
CREATE TABLE t (x INT) WITH SYSTEM VERSIONING 
  PARTITION BY SYSTEM_TIME 
    INTERVAL 1 MONTH 
    PARTITIONS 12;

-- 10.9.1 ã‹ã‚‰ AUTO å±æ€§ã‚‚ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚auto ã‚’ã¤ã‘ã‚‹ã¨ã©ã†ãªã‚‹â€¦ï¼Ÿ
CREATE TABLE t1 (x int) WITH SYSTEM VERSIONING
   PARTITION BY SYSTEM_TIME INTERVAL 1 MONTH
   STARTS '2021-01-01 00:00:00' AUTO PARTITIONS 12;

```

## å‰Šé™¤

Versioning ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãã—ã¦å†è¿½åŠ ã‚’ã™ã‚‹äº‹ã‚‚ã§ãã¾ã™ã€‚ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãŒå¤šããªã‚Šã€å±¥æ­´ãŒä¸è¦ã«ãªã£ãŸç­‰ãŒã‚ã‚‹æ™‚ã¯ã“ã‚“ãªæ„Ÿã˜ã§ãƒ‘ãƒ¼ã‚¸ã™ã‚‹ã®ã¯ã‚ã‚Šã£ã½ã„ã€‚

```sql
ALTER TABLE t DROP SYSTEM VERSIONING;
ALTER TABLE t ADD SYSTEM VERSIONING;

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹æ™‚ã¯ã“ã‚“ãªæ„Ÿã˜
ALTER TABLE t DROP PARTITION p0;

-- ã‚‚ã¡ã‚ã‚“ã€æ™®é€šã«å±¥æ­´å…¨ä»¶ã‚’æ¶ˆã™ã“ã¨ã‚‚å¯èƒ½
DELETE HISTORY FROM t;

-- æŒ‡å®šæ—¥ä»¥å‰ã®å±¥æ­´å‰Šé™¤ã‚‚å¯èƒ½
DELETE HISTORY FROM t BEFORE SYSTEM_TIME '2016-10-09 08:07:06';

```

æ³¨æ„äº‹é …ã¨ã—ã¦ã€å±¥æ­´æ©Ÿèƒ½ã®å‰¯ä½œç”¨ã¨ã—ã¦ TRANCATE ã¯å‹•ã‹ãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€[MariaDB 10.4.5](https://mariadb.com/kb/en/mariadb-1045-release-notes/) ã‚ˆã‚Šå‰ã¯å‹•ãã¾ã™ã€‚

### ç‰¹å®šã®ã‚«ãƒ©ãƒ ã®ã¿å±¥æ­´æ©Ÿèƒ½ã‚’ä½¿ã†

ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã§ã‚„ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ãŒã€ç‰¹å®šã®ã‚«ãƒ©ãƒ ã¯ã‚‚ãŸãªãã¦è‰¯ã„ã€æŒã¡ãŸã„ã€ãªã©ã®äº‹ãŒã§ãã¾ã™ã€‚

```sql
-- y ã®ã‚«ãƒ©ãƒ ã¯å±¥æ­´æ©Ÿèƒ½ã‚’ä½¿ã‚ãªã„
CREATE TABLE t (
   x INT,
   y INT WITHOUT SYSTEM VERSIONING
) WITH SYSTEM VERSIONING;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯å±¥æ­´æ©Ÿèƒ½ã‚’ä½¿ã‚ãªã„ãŒã€xã ã‘ä½¿ã„ãŸã„ã€‚
CREATE TABLE t (
   x INT WITH SYSTEM VERSIONING,
   y INT
);

```

# Application Time Periods

see : [Application-Time Periods -- mariadb.com](https://mariadb.com/kb/en/application-time-periods/)

ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ å†…ã«ã‚ã‚‹ï¼’ã¤ã®æ™‚é–“å‹ï¼ˆ *DATE*/*DATETIME*/*TIMESTAMP* ã®ä¸‰ç¨®é¡ã®ã¿ã€_YEAR_/_TIME_ ã¯æœªã‚µãƒãƒ¼ãƒˆï¼‰ã‚’è¦‹ã¦ã€æœŸé–“æŒ‡å®šã‚’ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã‚Œã¯ System Versioning ã¨ã¯åˆ¥ã®æ©Ÿèƒ½ã«ãªã‚‹ã€‚

è‹±èªçš„ã«ã¯ Time Period ã¨æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã«ç¿’ã£ã¦ Time Period ã¨æ›¸ã„ã¦ã„ãã€‚


## TimePeriod ã‚’è¿½åŠ ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®æ“ä½œ

ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ã€‚

```sql
MariaDB [sys_temporal]> create table rooms(
	room_number int,
	guest_name varchar(25),
	checkin date,
	checkout date,
	period for date_period(checkin, checkout));
Query OK, 0 rows affected (0.021 sec)

------------------------------------------------------------------------------------------------
-- ä½œæˆã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±

MariaDB [sys_temporal]> show create table rooms\g;
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                       |
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| rooms | CREATE TABLE `rooms` (
  `room_number` int(11) DEFAULT NULL,
  `guest_name` varchar(25) DEFAULT NULL,
  `checkin` date NOT NULL,
  `checkout` date NOT NULL,
  PERIOD FOR `date_period` (`checkin`, `checkout`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci |
+-------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.008 sec)


------------------------------------------------------------------------------------------------
-- time period ã‚’æ¶ˆã™

MariaDB [sys_temporal]> alter table rooms drop period for date_period;
Query OK, 0 rows affected (0.007 sec)
Records: 0  Duplicates: 0  Warnings: 0

------------------------------------------------------------------------------------------------
-- time period ã‚’è¿½åŠ ã™ã‚‹
MariaDB [sys_temporal]> alter table rooms add period for p(checkin, checkout);
Query OK, 0 rows affected (0.015 sec)              
Records: 0  Duplicates: 0  Warnings: 0


MariaDB [sys_temporal]> show create table rooms\g;
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                             |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| rooms | CREATE TABLE `rooms` (
  `room_number` int(11) DEFAULT NULL,
  `guest_name` varchar(25) DEFAULT NULL,
  `checkin` date NOT NULL,
  `checkout` date NOT NULL,
  PERIOD FOR `p` (`checkin`, `checkout`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.004 sec)
```

## ãƒ‡ãƒ¼ã‚¿æ“ä½œ

ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°å…¥ã‚Œã¦ã€ `FOR PORTION` æ–‡ã‚’ã¤ã‘ã¦æ—¥ä»˜ã„ã—ãŸDeleteæ–‡ã‚„Updateæ–‡ã‚’å®Ÿè¡Œã—ã€ã©ã†ãªã‚‹ã‹ã‚’è¦‹ã¦ã¿ã‚‹ã€‚ã¨ã‚Šã‚ãˆãšã€ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ä½¿ã†ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ã€‚

```sql
MariaDB [sys_temporal]> CREATE TABLE books(
    ->    name VARCHAR(50), 
    ->    start_date DATE,
    ->    end_date DATE,
    ->    PERIOD FOR date_period(start_date, end_date));
Query OK, 0 rows affected (0.016 sec)


MariaDB [sys_temporal]> insert into books (name, start_date, end_date) values
    ->                    ('å¤äºˆç´„', '2022-09-01', '2022-09-10'),
    ->                    ('ä¸€å¹´äºˆç´„', '2022-10-10', '2023-10-10'),
    ->                    ('åŠå¹´äºˆç´„', '2023-04-01', '2023-10-10'),
    ->                    ('äºˆç´„A', '2022-12-01', '2023-06-01'),
    ->                    ('äºˆç´„B', '2023-09-01', '2023-11-04');
Query OK, 5 rows affected (0.002 sec)
Records: 5  Duplicates: 0  Warnings: 0

MariaDB [sys_temporal]> select * from books;
+--------------+------------+------------+
| name         | start_date | end_date   |
+--------------+------------+------------+
| å¤äºˆç´„       | 2022-09-01 | 2022-09-10 |
| ä¸€å¹´äºˆç´„     | 2022-10-10 | 2023-10-10 |
| åŠå¹´äºˆç´„     | 2023-04-01 | 2023-10-10 |
| äºˆç´„A        | 2022-12-01 | 2023-06-01 |
| äºˆç´„B        | 2023-09-01 | 2023-11-04 |
+--------------+------------+------------+
5 rows in set (0.003 sec)
```

ã“ã“ã¾ã§ã® books ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ã‚’å¯è¦–åŒ–ã™ã‚‹ã€‚

```mermaid
gantt
dateFormat  YYYY-MM-DD
title books ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ³
excludes weekdays 2023-10-01

section A section
å¤ã„äºˆç´„ :done,   d1, 2022-09-01, 2022-09-10
ä¸€å¹´äºˆç´„ :active, dy, 2022-10-10, 2023-10-10
åŠå¹´äºˆç´„ :        dh, 2023-04-01, 2023-10-10
äºˆç´„A   :        da, 2022-12-01, 2023-06-01
äºˆç´„B   :        db, 2023-09-01, 2023-11-04
å‰Šé™¤å¤‰æ›´äºˆå®š: active, ddd, 2023-01-01, 2023-10-01
```

### ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤

```sql
------------------------------------------------------------------------------------------------
-- 2023-01-01 ã‹ã‚‰ 2023-10-01 ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ã¿ã‚‹
MariaDB [sys_temporal]> delete from books FOR PORTION of date_period from '2023-01-01' to '2023-10-01';
Query OK, 4 rows affected (0.002 sec)

MariaDB [sys_temporal]> select * from books;
+--------------+------------+------------+
| name         | start_date | end_date   |
+--------------+------------+------------+
| å¤äºˆç´„       | 2022-09-01 | 2022-09-10 |
| ä¸€å¹´äºˆç´„     | 2022-10-10 | 2023-01-01 |
| åŠå¹´äºˆç´„     | 2023-10-01 | 2023-10-10 |
| äºˆç´„A        | 2022-12-01 | 2023-01-01 |
| äºˆç´„B        | 2023-10-01 | 2023-11-04 |
| ä¸€å¹´äºˆç´„     | 2023-10-01 | 2023-10-10 |
+--------------+------------+------------+
6 rows in set (0.001 sec)

```

ã“ã“ã§ã€ã„ã‚ã„ã‚ãŠã‚‚ã—ã‚äº‹ãŒèµ·ãã‚‹ã€‚

1. å¤äºˆç´„ã¯ç¯„å›²å¤–ãªã®ã§æ¶ˆãˆãªã„
2. ä¸€å¹´äºˆç´„ã¯ 2022-10-10 ~ 2023-10-10 ã®ç¯„å›²ã§ã‚ã£ãŸã®ã§ã€*2022-10-10 ~ 2023-01-01* ã¨ *2023-10-01 ~ 2023-10-10* ã®ï¼’ã¤ã«åˆ†ã‹ã‚Œã‚‹ã€‚
3. åŠå¹´äºˆç´„ã¯ 2023-04-01 ~ 2023-10-10 ã®ç¯„å›²ã§ã‚ã£ãŸã®ã§ã€å§‹ã¾ã‚Šã®æ—¥ãŒ 2023-10-01 ã¨ãªã‚‹ã€‚
4. äºˆç´„Aã¯ 2022-12-01 ~ 2023-06-01 ã®ç¯„å›²ã§ã‚ã£ãŸãŒã€çµ‚ã‚ã‚Šã®æ—¥ãŒ 2023-01-01 ã«ãªã‚‹ã€‚
5. äºˆç´„B ã¯ 2023-09-01 ~ 2023-11-04 ã®ç¯„å›²ã§ã‚ã£ãŸãŒã€åˆã‚ã®æ—¥ãŒ 2023-10-01 ã«ãªã‚‹ã€‚

### ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ã—ã¦ã¿ã‚‹

ä¸Šè¨˜ã®DBã§å‰Šé™¤ã™ã‚‹å‰ã®çŠ¶æ…‹ã«ã—ã¦ã€æ›´æ–°ã‚’ã—ã¦ã¿ã‚‹ã€‚

```sql
MariaDB [sys_temporal]> UPDATE books FOR PORTION OF date_period
    ->   FROM '2023-01-01' to '2023-10-01' 
    -> SET name = CONCAT(name,'_original');
Query OK, 4 rows affected (0.003 sec)
Rows matched: 4  Changed: 4  Inserted: 5  Warnings: 0

MariaDB [sys_temporal]> select * from books;
+-----------------------+------------+------------+
| name                  | start_date | end_date   |
+-----------------------+------------+------------+
| å¤äºˆç´„                | 2022-09-01 | 2022-09-10 |
| ä¸€å¹´äºˆç´„_original     | 2023-01-01 | 2023-10-01 |
| åŠå¹´äºˆç´„_original     | 2023-04-01 | 2023-10-01 |
| äºˆç´„A_original        | 2023-01-01 | 2023-06-01 |
| äºˆç´„B_original        | 2023-09-01 | 2023-10-01 |
| ä¸€å¹´äºˆç´„              | 2022-10-10 | 2023-01-01 |
| ä¸€å¹´äºˆç´„              | 2023-10-01 | 2023-10-10 |
| åŠå¹´äºˆç´„              | 2023-10-01 | 2023-10-10 |
| äºˆç´„A                 | 2022-12-01 | 2023-01-01 |
| äºˆç´„B                 | 2023-10-01 | 2023-11-04 |
+-----------------------+------------+------------+
10 rows in set (0.001 sec)

```

Delete æ™‚ã¨ä¼¼ãŸã‚ˆã†ã«ã€æŒ‡å®šæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒå½±éŸ¿ã‚’ã‚¦ã‚±ã‚‹ã€‚


# Bitemporal Table

# è©¦ã—

ã¨ã‚Šã‚ãˆãš docker ã§ã•ãã£ã¨ã¨ç«‹ã¡ä¸Šã’ã¦ã€ã©ã†ãªã£ã¦ã„ã‚‹ã‹è¦‹ã‚‹ã€‚

```
 âš“  ~/d/test-temporal-table-at-mariadb  echo 'version: "3.1"
                                         services:
                                           mariadb:
                                             image: mariadb:11.1
                                             volumes:
                                               - ./db_data:/var/lib/mysql
                                             environment:
                                               MARIADB_ROOT_PASSWORD: example
                                         ' > docker-compose.yml

 âš“  ~/d/test-temporal-table-at-mariadb  docker compose up -d
[+] Running 9/9
 âœ” mariadb 8 layers [â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿]      0B/0B      Pulled                     15.4s 
   âœ” 6ea603f1df5e Pull complete                                            3.1s 
   âœ” ccf83fcbd3f9 Pull complete                                            0.8s 
   âœ” b1db0fbcea43 Pull complete                                            1.5s 
   âœ” 840258738964 Pull complete                                            1.7s 
   âœ” e00d176ef650 Pull complete                                            2.5s 
   âœ” 3eae2bb1c643 Pull complete                                            7.7s 
   âœ” b6408b7f2598 Pull complete                                            3.3s 
   âœ” 30c8ffa0af98 Pull complete                                            3.9s 
[+] Running 2/2
 âœ” Network test-temporal-table-at-mariadb_default      Created             0.1s 
 âœ” Container test-temporal-table-at-mariadb-mariadb-1  Started             0.3s 
```
