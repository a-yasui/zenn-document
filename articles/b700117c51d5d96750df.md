---
title: "Laravel Sanctum ãƒ¡ãƒ¢"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['laravel']
published: true
---

# Laravel Sanctum ã‚’å°‘ã—ä½¿ã£ãŸãƒ¡ãƒ¢

Laravel Sanctum ã¯ Token ã‚’ç™ºè¡Œã—ã¦ã€HTTP ã® `Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‹ã„ã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼ã™ã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã§ã™ã€‚Github ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¿ãŸã„ãªæ„Ÿã˜ã€‚

ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¶å˜ä½ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãŒå±ã—ã¦ã‚‹çµ„ç¹”å˜ä½ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã‚ˆã†ã¨ã—ã€SPAã§ã¯ä½¿ã‚ãªã„ã¨ã„ã†æ„Ÿã˜ã«ã™ã‚‹ã€‚

ãã„ã§ã€ã©ã†ã‚‚ JetStream ã‚’ä½¿ãˆã°æ¥½ã«ã§ãã‚‹ã¿ãŸã„ãªã‚“ã§ã™ãŒã€ä»Šå›ã¯ãƒ‘ã‚¹ã—ã¦ã¾ã™ã€‚

- PHP 7.4
- Laravel 8.56.0
- laravel/sanctum v2.11.2


## å°å…¥æ–¹æ³•

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã‚“ã§ã€‚

see : https://readouble.com/laravel/8.x/ja/sanctum.html


### å°å…¥å¾Œã®å¤‰æ›´ç‚¹

1. `php artisan vendor:publish --tag=sanctum-migrations` ã®å¾Œã« `database/migrations/2019_12_14_000001_create_personal_access_tokens_table.php` ãŒä½œæˆã•ã‚Œ `personal_tokens` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚Šã¾ã™ãŒã€åå‰ãŒç´›ã‚‰ã‚ã—ã„ã®ã§ `organization_access_tokens` ã«å¤‰æ›´ã‚’ã—ã¦ã„ã¾ã™ã€‚

## ER å›³

ãƒ¦ãƒ¼ã‚¶ `users` ã¯ è¤‡æ•°ã®çµ„ç¹” `organizations` ã«å±ã—ã¦ã„ã‚‹å½¢ã€‚

```mermaid
erDiagram
	users ||--o{ organizations : has

	users {
		string name
		string email
		string password
	}

	organizations {
		string name
	}

	organizations ||--o{ organization_access_tokens : has

	organization_access_tokens {
		string tokenable_type
		bigint tokenable_id
		string name
		string token
		text abilities
		timestamp last_used_at
	}
```

# è¨­å®šã®å¤‰æ›´

API Token ã¨ã—ã¦ä½¿ã„ãŸã„ã ã‘ãªã®ã§ API çµŒç”±ã§ CSRF-Token ã®å–å¾—ã¯ä¸è¦ã§ã™ã€‚ã—ãŸãŒã£ã¦ `config/sanctum.php` ã«ä¸€è¡Œè¿½åŠ ã—ã¦ã‚„ã‚Šã¾ã™ã€‚

```php
<?php
// config/sanctum.php

    // ä»¥ä¸‹è¿½åŠ 
    // API Tokenã¨ã—ã¦ä½¿ã„ã€SPAã¨ã—ã¦ã¯ä½¿ã‚ãªã„ã®ã§ Routing ã«ã‚ã‚‹ csrf-token ã¯ã‚ªãƒ•ã«ã™ã‚‹
    'routes' => false,
];
```

## Eloquent ã®ä½œæˆ

organizations ãƒ†ãƒ¼ãƒ–ãƒ« ã‚’è¿½åŠ ã—ãŸå¾Œã€è‰²ã€…ä½¿ã†ã®ã§ `App\Models\Organization` ã‚’è¿½åŠ ã™ã‚‹ã€‚ï¼ˆå…¨éƒ¨æ›¸ã„ãŸã‚‰é•·ã„ã®ã§æœ€ä½éƒ¨åˆ†ã ã‘ï¼‰


```php
<?php
// app/Models/Organizations.php
namespace App\Models;

/**
 * Authenticatable ã‚’æº€ãŸã•ãªã„ã¨ Auth::user() ã§å–ã£ã¦ã“ã‚Œãªããªã‚‹ã®ã§ã€ç„¡ç†ã‚„ã‚Šå®Ÿè£…
 */ 
class Organizations extends Model implements Authenticatable
{
    use HasFactory, HasApiTokens; // HasApiTokens ãŒå¿…é ˆ

    protected $table = 'organizations';
...
}
```

## èªè¨¼ã‚’ Organization ã«ã™ã‚‹

Sanctum ã®æ¨™æº–ã§ã¯ User ã«ç´ã¥ãå½¢ã«ãªã£ã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ Organizations ã¨ã„ã†æ‰€ã«é–¢é€£ã¥ã‘ã‚’ã™ã‚‹ã®ã§ã€ãã‚Œã®è¨­å®šã‚’å¤‰æ›´ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ã¾ãš Laravel ãŒç”¨æ„ã—ã¦ã„ã‚‹ `PersonalAccessToken` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„ã—ã€ `AppServiceProvider` ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã¯ [å…¬å¼-- readouble.com/laravel/8.x](https://readouble.com/laravel/8.x/ja/sanctum.html#overriding-default-models) ã«è¼‰ã£ã¦ã¾ã™ã­ ã€‚

ã¾ãš `PersonalAccessToken` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ `OrganizationTokens` ã‚’ç”¨æ„ã—ã¦ã‚„ã‚Šã¾ã™ã€‚

```php
<?php
// app/Models/OrganizationTokens.php
namespace App\Models;

use Laravel\Sanctum\PersonalAccessToken as SanctumPersonalAccessToken;

class OrganizationTokens extends SanctumPersonalAccessToken
{
    protected $table = 'organization_access_tokens';
}

```

ãã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã‚„ã‚Šã¾ã™ã€‚

```php
<?php
// app/Providers/AppServiceProvider.php
class AppServiceProvider extends ServiceProvider
{
    /**
     * @return void
     */
    public function boot()
    {
        // Token ã¯ user ã§ã¯ãªã organizations ã«ç´ä»˜ã‘ã¦ã„ã‚‹ã®ã§ã€æ„å›³çš„ã«ç½®ãæ›ãˆã¦ã‚„ã‚‹
        \Laravel\Sanctum\Sanctum::usePersonalAccessTokenModel( \App\Models\OrganizationTokens::class );
    }
}
```

#### å€‹äººçš„ãƒ¡ãƒ¢æ›¸ã æŒ™å‹•ãƒ¡ãƒ¢

ä»Šã¾ã§ã ã¨ `User` ã« email/password ãŒã‚ã‚Šã€ãã‚ŒãŒãã®ã¾ã¾ Auth::user() ã§è¿”ã—ã¦ãã¾ã™ãŒã€ä»Šå›ã¯ `OrganizationTokens` ã§èªè¨¼ã—ã¦ã€Auth::user() ãŒè¿”ã™å€¤ã¯ `Organizations` ã®å€¤ã«ãªã‚Šã¾ã™ã€‚ã“ã®é•ã„ã¯ä½•ã‹ã¨ã¼ã‚“ã‚„ã‚Šæµã‚Œã‚’è¿½ã£ãŸã‚‰ã€ Auth::user() ã§è¿”ã™å€¤ã¯ [Sumctum ã® Guard -- github](https://github.com/laravel/sanctum/blob/2.x/src/Guard.php) ã‚’ã¿ã‚‹ã¨ã€`PersonalAccessToken` ã«ã‚ã‚‹ `tokenable` ãƒ¡ã‚½ãƒƒãƒ‰ã®å€¤ã‚’è¿”ã—ã¦ã¾ã™ã€‚ã“ã„ã¤ã®ä¸­èº«ã¯ `return $this->morphTo('tokenable');` ã¨ã„ã†æ„Ÿã˜ã«ãªã£ã¦ãŠã‚Šã€å®Ÿãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¦‹ã‚‹ã¨ `tokenable_type/tokenable_id` ã®ï¼’ã¤ã®ã‚«ãƒ©ãƒ ã‚’ç”Ÿæˆã—ã¦ã€ãã‚Œãã‚Œ `App\Models\Organizations` ã¨ `1` ã¨ã„ã£ãŸæ„Ÿã˜ã§ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚è¦ã¯ [ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](https://readouble.com/laravel/8.x/ja/eloquent-relationships.html#polymorphic-relationships) ã§ã™ã­ã€‚


### 1. auth.guards.sanctum ã¨ auth.providers.organizations ã‚’è¿½åŠ 


```php
<?php
// config/auth.php
return [
    'guards' => [

    	// è¿½åŠ 
        'sanctum' => [
            'driver' => 'sanctum',
            'provider' => 'organizations'
        ],
    ],
    'providers' => [

    	// è¿½åŠ 
        'organizations' => [
            'driver' => 'eloquent',
            'model' => App\Models\Organizations::class,
        ]
    ]
]

```

### 2. ä½¿ã£ã¦ã¿ã‚‹

`api.php` ã«ã•ã‚‰ã£ã¨ Organizationã®æƒ…å ±ã‚’è¿”ã™ã‚ˆã†ã«ä»•å‘ã‘ã¦ã¿ã¾ã™ã€‚

```php
<?php
// routes/api.php
Route::group( ['middleware' => 'auth:sanctum'], function () {
    Route::get( '/user', function ( Request $request ) {
        return [
            'class' => get_class($request->user()),
            'data' => $request->user()
        ];
    } );
} );

```

ä»¥ä¸‹å®Ÿè¡Œçµæœ

```shell
âš‘  curl -vvv -H 'Authorization: Bearer 4|ZFbPA7Ul9iPaoHz6m3o4eAQ2crL5NsNh8zC9gg8K'  -H 'Content-Type: application/json' -H 'Accept: application/json'  http://hoge_test.homestead/api/user
*   Trying 192.168.73.10...
* TCP_NODELAY set
* Connected to hoge_test.homestead (192.168.73.10) port 80 (#0)
> GET /api/user HTTP/1.1
> Host: hoge_test.homestead
> User-Agent: curl/7.64.1
> Authorization: Bearer 4|ZFbPA7Ul9iPaoHz6m3o4eAQ2crL5NsNh8zC9gg8K
> Content-Type: application/json
> Accept: application/json
> 
< HTTP/1.1 200 OK
< Server: nginx/1.18.0 (Ubuntu)
< Content-Type: application/json
< Transfer-Encoding: chunked
< Connection: keep-alive
< Cache-Control: no-cache, private
< Date: Thu, 02 Sep 2021 07:30:07 GMT
< X-RateLimit-Limit: 60
< X-RateLimit-Remaining: 59
< phpdebugbar-id: X7162886b2e4875d8bc109a63ad1e2fa1
< Access-Control-Allow-Origin: *
< 
* Connection #0 to host hoge_test.homestead left intact
{"class":"App\\Models\\Organizations","data":{"id":1,"name":"hoge","created_at":"2021-09-01T12:15:48.000000Z","updated_at":"2021-09-01T12:15:48.000000Z"}}* Closing connection 0

```


## ãƒ†ã‚¹ãƒˆ

ã¡ã‚‡ã£ã¨ãƒˆãƒªãƒƒã‚­ãƒ¼ãªäº‹ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã‚‚ãã‚Œã«åˆã‚ã›ã¦ãƒˆãƒªãƒƒã‚­ãƒ¼ã«ã—ã¾ã™ã€‚ã¾ãšã€ã‚ˆãã‚ã‚‹ `$this->actingAPIAs($organization)->get(url)` ã¨ã„ã£ãŸæ„Ÿã˜ã§ API ã®å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å…ƒã¨ãªã‚‹ã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„ã—ã¦ã€æ›¸ãè¾¼ã‚“ã§ã„ãã¾ã™ã€‚

```php
<?php
// tests/APIDatabaseTestCase.php
namespace Tests;

use App\Models\Organizations;
use Laravel\Sanctum\Sanctum;

/**
 *
 */
abstract class APIDatabaseTestCase extends DatabaseTestCase
{
    /**
     * @param Organizations $organizations
     * @param array $abilities
     * @return $this
     */
    public function actingAPIAs( Organizations $organizations, $abilities = [] )
    {
        Sanctum::actingAs( $organizations, $abilities );
        return $this;
    }

    /**
     * @param string $uri
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    public function get( $uri, array $headers = [] )
    {
        return parent::get( $uri, array_merge( [
            'Content-Type' => 'application/json',
            'Accept' => 'application/json'
        ], $headers ) );
    }

    /**
     * @param string $uri
     * @param array $data
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    public function post( $uri, array $data = [], array $headers = [] )
    {
        return parent::post( $uri, $data, array_merge( [
            'Content-Type' => 'application/json',
            'Accept' => 'application/json'
        ], $headers ) );
    }
}

```

å¾Œã¯ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã€ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã§ `$this->actingAPIAs($organization)->get(url)` ã¨ã„ã£ãŸæ„Ÿã˜ã§æ›¸ã„ã¦ã„ãã€‚


